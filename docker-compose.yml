version: '3.8'

services:
  # Django Backend
  backend:
    build:
      context: ./survey-backend
      dockerfile: Dockerfile
    container_name: taam_backend
    restart: always
    volumes:
      - ./survey-backend:/app
      - media_data:/app/media
      - static_data:/app/static
      - db_data:/app/media/database
    environment:
      - DEBUG=False
      - DEPLOYMENT_ENV=dev
      - SECRET_KEY=${SECRET_KEY:-your-secret-key-change-this-in-production}
      - ALLOWED_HOSTS=taam-api.akeleon.com,83.212.122.10,localhost,127.0.0.1
      - CORS_ALLOWED_ORIGINS=https://taam-app.akeleon.com,http://83.212.122.10:3000,http://83.212.122.10,http://localhost:3000
      - CSRF_TRUSTED_ORIGINS=https://taam-app.akeleon.com,https://taam-api.akeleon.com,http://83.212.122.10:3000,http://83.212.122.10
      - CORS_ORIGIN_WHITELIST=https://taam-app.akeleon.com,http://83.212.122.10
      - FRONTEND_URL=https://taam-app.akeleon.com
    networks:
      - taam_network
    expose:
      - "8000"
    command: >
      sh -c "python manage.py migrate &&
             python manage.py collectstatic --noinput &&
             gunicorn config.wsgi:application --bind 0.0.0.0:8000 --workers 4 --timeout 120"

  # Next.js Frontend
  frontend:
    build:
      context: ./survey-frontend
      dockerfile: Dockerfile
      args:
        - NEXT_PUBLIC_API_URL=https://taam-api.akeleon.com/api
    container_name: taam_frontend
    restart: always
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=https://taam-api.akeleon.com/api
    networks:
      - taam_network
    expose:
      - "3000"

  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: taam_nginx
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./certbot/conf:/etc/letsencrypt:ro
      - ./certbot/www:/var/www/certbot:ro
      - static_data:/var/www/static:ro
      - media_data:/var/www/media:ro
    depends_on:
      - backend
      - frontend
    networks:
      - taam_network

  # Certbot for SSL certificates
  certbot:
    image: certbot/certbot
    container_name: taam_certbot
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
    networks:
      - taam_network

networks:
  taam_network:
    driver: bridge

volumes:
  db_data:
  media_data:
  static_data:
